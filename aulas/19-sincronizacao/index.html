


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://insper.github.io/SistemasHardwareSoftware/aulas/19-sincronizacao/">
      
      
        <meta name="author" content="Igor Montagner">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.12">
    
    
      
        <title>19 - Sincronização - Sistemas Hardware-Software - 2020/2</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4dd2dd8d.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.6a5ad368.min.css">
      
      
        
        
        <meta name="theme-color" content="#795649">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/printing.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="brown" data-md-color-accent="amber">
  
    
      <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#19-sincronizacao" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      











<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->

<script>
  window.site_url = "https://insper.github.io/SistemasHardwareSoftware/";
</script>

<div class="md-printing-header">
  <img class="cabecalho" src="https://insper.github.io/SistemasHardwareSoftware/css/cabecalho.png">
  <img class="logo" src="https://insper.github.io/SistemasHardwareSoftware/css/logo.png">

  <div class="frontmatter">
    <div class="materia"> Sistemas Hardware-Software </div>
    <div class="professor"> Igor Montagner </div>
    <div class="semestre"> 2020/2 </div>
  </div>
</div>

<header class="md-header" data-md-component="header">

  <!-- Top-level navigation -->
  <nav class="md-header-nav md-grid" aria-label="Header">

    <!-- Link to home -->
    <a
      href="https://insper.github.io/SistemasHardwareSoftware/"
      title="Sistemas Hardware-Software - 2020/2"
      class="md-header-nav__button md-logo"
      aria-label="Sistemas Hardware-Software - 2020/2"
    >
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>

    <!-- Button to open drawer -->
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Sistemas Hardware-Software - 2020/2
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              19 - Sincronização
            
          </span>
        </div>
      
    </div>

    <!-- Button to open search dialogue -->
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>

      <!-- Search interface -->
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    

    <!-- Repository containing source -->
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/insper/sistemashardwaresoftware/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    sistemashardwaresoftware
  </div>
</a>
      </div>
    
  </nav>
</header>




    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://insper.github.io/SistemasHardwareSoftware/" title="Sistemas Hardware-Software - 2020/2" class="md-nav__button md-logo" aria-label="Sistemas Hardware-Software - 2020/2">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Sistemas Hardware-Software - 2020/2
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/insper/sistemashardwaresoftware/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    sistemashardwaresoftware
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../sobre/" title="Burocracias" class="md-nav__link">
      Burocracias
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Aulas
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Aulas" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Aulas
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-introducao/" title="01 e 02 - Exercícios de C" class="md-nav__link">
      01 e 02 - Exercícios de C
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02-inteiros/" title="02 - Inteiros na CPU" class="md-nav__link">
      02 - Inteiros na CPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03-ram/" title="03 - Representação de dados em RAM" class="md-nav__link">
      03 - Representação de dados em RAM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../04-asm-1/" title="04 - Registradores x64 e variáveis globais" class="md-nav__link">
      04 - Registradores x64 e variáveis globais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../05-funcoes/" title="05 - Funções" class="md-nav__link">
      05 - Funções
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../06-condicionais/" title="06 - Condicionais" class="md-nav__link">
      06 - Condicionais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../07-loops/" title="07 - Loops" class="md-nav__link">
      07 - Loops
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../08-variaveis-locais/" title="08 - Variáveis locais" class="md-nav__link">
      08 - Variáveis locais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../09-arrays/" title="09 - Array em Assembly" class="md-nav__link">
      09 - Array em Assembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../10-malloc/" title="10 - Alocação Dinâmica de Memória" class="md-nav__link">
      10 - Alocação Dinâmica de Memória
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../11-tipos-de-dados/" title="11 - Tipos abstratos de dados" class="md-nav__link">
      11 - Tipos abstratos de dados
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../12-linux-do-zero/" title="12 - Linux do Zero" class="md-nav__link">
      12 - Linux do Zero
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../13-entrada-saida/" title="13 - Entrada/Saída" class="md-nav__link">
      13 - Entrada/Saída
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../14-processos/" title="14 - Processos" class="md-nav__link">
      14 - Processos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../15-exec/" title="15 - Carregamento de programas" class="md-nav__link">
      15 - Carregamento de programas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../16-sinais-1/" title="16 - Sinais 1" class="md-nav__link">
      16 - Sinais 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../17-sinais-2/" title="17 - Capturando sinais" class="md-nav__link">
      17 - Capturando sinais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../18-threads/" title="18 - Concorrência e Threads" class="md-nav__link">
      18 - Concorrência e Threads
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        19 - Sincronização
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="19 - Sincronização" class="md-nav__link md-nav__link--active">
      19 - Sincronização
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aquecimento" class="md-nav__link">
    Aquecimento
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sincronizacao-usando-mutex" class="md-nav__link">
    Sincronização usando mutex
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#economizando-mutex" class="md-nav__link">
    Economizando mutex
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../99-corretor-automatico/" title="99 - Corretor Automático" class="md-nav__link">
      99 - Corretor Automático
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Projetos
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Projetos" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Projetos
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/bomblab/" title="Bomb Lab" class="md-nav__link">
      Bomb Lab
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/posix/" title="Linux do Zero" class="md-nav__link">
      Linux do Zero
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aquecimento" class="md-nav__link">
    Aquecimento
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sincronizacao-usando-mutex" class="md-nav__link">
    Sincronização usando mutex
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#economizando-mutex" class="md-nav__link">
    Economizando mutex
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/insper/sistemashardwaresoftware/edit/master/docs/aulas/19-sincronizacao/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="19-sincronizacao">19 - Sincronização<a class="headerlink" href="#19-sincronizacao" title="Permanent link">&para;</a></h1>
<p>Na última aula aprendemos as APIs da biblioteca <code>pthread</code> para criar e esperar a finalização de threads. Também aprendemos a passar argumentos e receber de volta valores usando um <code>struct</code> alocado dinamicamente. </p>
<h2 id="aquecimento">Aquecimento<a class="headerlink" href="#aquecimento" title="Permanent link">&para;</a></h2>
<p>Vamos iniciar uma revisão trabalhando em cima do arquivo <code>soma_global.c</code>. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Abra o arquivo e analise seu conteúdo.</p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Qual o papel da função <code>soma_parcial</code>?  Explique o papel de cada atributo de </p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Como você setaria os atributos de <code>struct soma_partical_args</code> para obter a soma do vetor todo? E para obter somente a soma da primeira metade do vetor?</p>
</div>
<p>Para fins didáticos, estamos atualizando diretamente a variável <code>soma_total</code> dentro do <code>for</code>. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Complete as partes faltantes e rode o programa. Ele dá os resultados esperados? Teste para valores de <code>n</code> incrementalmente maiores.</p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Os resultados acima estarão errados. Você consegue explicar por que?</p>
</div>
<h2 id="sincronizacao-usando-mutex">Sincronização usando <code>mutex</code><a class="headerlink" href="#sincronizacao-usando-mutex" title="Permanent link">&para;</a></h2>
<p>Vamos agora trabalhar agora para corrigir este erro! Lembrando da aula, as operações possíveis são as seguintes:</p>
<ul>
<li><code>lock</code> - se tiver destravado, trava e continua; se não estiver espera.</li>
<li><code>unlock</code> - se tiver a trava, a destrava e permite que outras tarefas travem.</li>
</ul>
<p>Note que não existe garantia de ordem! Ou seja, se tiverem vários processos esperando por um <code>mutex</code> qualquer um deles pode receber o acesso. Inclusive, uma thread pode esperar "para sempre" e nunca receber o acesso. Não é provável, mas é possível.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Você pode precisar instalar o pacote <code>manpages-posix-dev</code> para obter as páginas do manual usadas neste roteiro.</p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Identifique no seu código quais linhas compõe a região crítica e onde deveriam estar as diretivas <code>lock</code> e <code>unlock</code>. Escreva abaixo suas concluões.</p>
</div>
<p>!<a class="magiclink magiclink-github magiclink-pull" href="https://github.com/squidfunk/mkdocs-material/pull/1" title="GitHub Pull Request: squidfunk/mkdocs-material!1">!1</a> example
     Coloque um comentário nas linhas identificadas acima. </p>
<p>Já sabemos onde iremos colocar as operações de <code>lock</code> e <code>unlock</code> do mutex. Agora falta só criá-lo. </p>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>O mutex precisa ser criado e inicializado. Onde isto deve ser feito? Como ele pode ser recebido pela função da thread?</p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Consulte o manual de <code>pthread_mutex_init</code> e escreva abaixo como criar e inicializar um mutex. </p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Consulte o manual de <code>pthread_mutex_lock</code> e <code>pthread_mutex_unlock</code> e escreva abaixo como usá-las.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Com base nas suas respostas acima, conserte seu programa <code>soma_global.c</code> e verifique que ele retorna os resultados corretos. </p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Agora meça o tempo de execução e anote abaixo. Compare com o original (que não funcionava) e explique a diferença.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Usar <code>mutex</code> é muito caro! Além de acabar com o paralelismo, as operações <code>lock</code> e <code>unlock</code> também são custosas.</p>
</div>
<h2 id="economizando-mutex">Economizando <code>mutex</code><a class="headerlink" href="#economizando-mutex" title="Permanent link">&para;</a></h2>
<p>Nesta parte final iremos ver como diminuir o número de chamadas ao <code>mutex</code>.</p>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>É necessário atualizar a variável global <code>soma</code> a cada iteração do <code>for</code>? E é possível atualizá-la somente uma vez?</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Implemente a ideia acima e veja se houve melhora. Salve como <code>soma-global2.c</code>.</p>
</div>
<p>O exercício acima deverá ter desempenho bom, já que limitamos a quantidade de vezes que usamos o <code>mutex</code>. Vamos tentar outra ideia agora.</p>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Precisamos da variável global? E se cada thread retornasse sua soma parcial? Como o programa poderia ser organizado para que essa ideia funcione? </p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>A ideia acima precisou de <code>mutex</code>? Por que?</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Implemente a ideia acima e confira os resultados. Houve melhora no desempenho?  </p>
</div>
<!--
# Parte 2 - semáforos

Usamos `mutex` quando precisamos criar regiões de **exclusão mútua** onde somente uma thread pode entrar por vez. Esta restrição é muito forte e não contempla outro caso muito comum em programação concorrente: sincronização de threads. Ou seja, o objetivo não é proteger o acesso a dados compartilhados, mas sim impor restrições no progresso das threads de maneira que elas estejam sempre em uma situação válida. Para isto trabalharemos com **semáforos**, que são um mecanismo de sincronização mais sofisticado e geral usado para que threads sincronizem seu progresso e possam executar **em paralelo**.

**Definição**: duas tarefas podem ser feitas em paralelo se

1. elas não compartilham absolutamente nenhuma informação.
1. elas compartilham informação mas possuem **mecanismos de sincronização** de tal maneira que **toda ordem de execução possível** de suas instruções resulte no mesmo resultado final.

**Semáforos** ajudam a criar programas no segundo caso. Nesta aula iremos olhar o caso mais simples de sincronização: duas threads combinam de só progredirem quando chegarem em um certo ponto do programa.

## Rendez-vous

A expressão *Rendez-vous* significa, literalmente, *encontro* em francês. Ela é usada para marcar um horário para duas ou mais pessoas se encontrarem. No contexto de sincronização de tarefas, ele também é usado para nomear o problema de sincronização mais simples: duas threads rodando funções distintas precisam se sincronizar no meio de suas funções.

![Tarefas sincronizadas usando um RDV](rdv.svg){width=400px}

As partes A e B podem ser feitas em qualquer ordem, mas ambas obrigatoriamente devem ocorrer antes de iniciar a execução de C e D. Note que C e D também podem ser feitas em qualquer ordem.

<div class="alert"> Quando dizemos que duas tarefas podem ser feitas em qualquer ordem não quer dizer que elas possam ser feitas em paralelo! Apenas estamos dizendo que A inteira pode ocorrer antes ou depois de B inteira e os resultados serão os mesmos.  </div>

\newpage

**Exercício**: Marque abaixo as ordens de execução possíveis para as partes A, B, C e D.

1. A C B D
1. A B C D
1. B D A C
1. B A D C
1. B A C D

Vamos fazer a solução do RDV no papel primeiro.

**Inicialização**: Preencha aqui quantos semáforos serão usados, seus nomes e valores iniciais. \vspace{3em}

**Sua solução**: Indique abaixo em quais quadrados azuis você usaria seus semáforos para resolver o RDV. Você pode usar mais de um semáforo em um mesmo quadrado e pode deixar os outros vazios.

## Semáforos POSIX

A página `sem_overview` do manual contém um resumo do uso de semáforos. A partir de seu conteúdo responda as questões abaixo.

**Exercício**: Qual o tipo de variável usada para guardar um semáforo? Quais funções são usadas para criar e destruir cada tipo de semáforo? \vspace{5em}

**Exercício**: Quais as funções usadas para incrementar e decrementar um semáforo? \vspace{5em}

**Exercício**: Implemente (do zero) um programa que cria duas threads e as sincroniza usando *RDV*. Ambas deverão fazer um `print` antes e um depois do ponto de encontro.

# Parte 3 - Entrega

**Exercício**: adapte o exercício da soma do vetor para calcular também a variância. Percebam que agora temos duas partes que tem uma relação de dependência:

1. Computar a soma (divida em duas partes)
1. Computar a variância (que depende da soma)

Use *RDV* para sincronizar as duas threads e você deverá implementar tudo na função

<div class="highlight"><pre><span></span><code>void *computa_media_variancia(void *)
</code></pre></div>

Salve sua solução em um arquivo `var1.c` e entregue via blackboard.
-->
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../18-threads/" title="18 - Concorrência e Threads" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                18 - Concorrência e Threads
              </div>
            </div>
          </a>
        
        
          <a href="../99-corretor-automatico/" title="99 - Corretor Automático" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                99 - Corretor Automático
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.3636a4ec.min.js"></script>
      <script src="../../assets/javascripts/bundle.e9fe3281.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
      
        <script src="../../translate-admonitions.js"></script>
      
    
  </body>
</html>