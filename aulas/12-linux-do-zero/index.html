


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://insper.github.io/SistemasHardwareSoftware/aulas/12-linux-do-zero/">
      
      
        <meta name="author" content="Igor Montagner">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>12 - Linux do Zero - Sistemas Hardware-Software - 2020/2</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.63b94e9e.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7f672a1f.min.css">
      
      
        
        
        <meta name="theme-color" content="#795548">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/printing.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="brown" data-md-color-accent="amber">
  
    
      <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#12-linux-do-zero" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      











<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->

<script>
  window.site_url = "https://insper.github.io/SistemasHardwareSoftware/";
</script>

<div class="md-printing-header">
  <img class="cabecalho" src="https://insper.github.io/SistemasHardwareSoftware/css/cabecalho.png">
  <img class="logo" src="https://insper.github.io/SistemasHardwareSoftware/css/logo.png">

  <div class="frontmatter">
    <div class="materia"> Sistemas Hardware-Software </div>
    <div class="professor"> Igor Montagner </div>
    <div class="semestre"> 2020/2 </div>
  </div>
</div>

<header class="md-header" data-md-component="header">

  <!-- Top-level navigation -->
  <nav class="md-header-nav md-grid" aria-label="Header">

    <!-- Link to home -->
    <a
      href="https://insper.github.io/SistemasHardwareSoftware/"
      title="Sistemas Hardware-Software - 2020/2"
      class="md-header-nav__button md-logo"
      aria-label="Sistemas Hardware-Software - 2020/2"
    >
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>

    <!-- Button to open drawer -->
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Sistemas Hardware-Software - 2020/2
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              12 - Linux do Zero
            
          </span>
        </div>
      
    </div>

    <!-- Button to open search dialogue -->
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>

      <!-- Search interface -->
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    

    <!-- Repository containing source -->
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/insper/sistemashardwaresoftware/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    sistemashardwaresoftware
  </div>
</a>
      </div>
    
  </nav>
</header>




    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://insper.github.io/SistemasHardwareSoftware/" title="Sistemas Hardware-Software - 2020/2" class="md-nav__button md-logo" aria-label="Sistemas Hardware-Software - 2020/2">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Sistemas Hardware-Software - 2020/2
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/insper/sistemashardwaresoftware/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    sistemashardwaresoftware
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../sobre/" title="Burocracias" class="md-nav__link">
      Burocracias
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Aulas
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Aulas" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Aulas
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-introducao/" title="01 e 02 - Exercícios de C" class="md-nav__link">
      01 e 02 - Exercícios de C
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02-inteiros/" title="02 - Inteiros na CPU" class="md-nav__link">
      02 - Inteiros na CPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03-ram/" title="03 - Representação de dados em RAM" class="md-nav__link">
      03 - Representação de dados em RAM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../04-asm-1/" title="04 - Registradores x64 e variáveis globais" class="md-nav__link">
      04 - Registradores x64 e variáveis globais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../05-funcoes/" title="05 - Funções" class="md-nav__link">
      05 - Funções
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../06-condicionais/" title="06 - Condicionais" class="md-nav__link">
      06 - Condicionais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../07-loops/" title="07 - Loops" class="md-nav__link">
      07 - Loops
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../08-variaveis-locais/" title="08 - Variáveis locais" class="md-nav__link">
      08 - Variáveis locais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../09-arrays/" title="09 - Array em Assembly" class="md-nav__link">
      09 - Array em Assembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../10-malloc/" title="10 - Alocação Dinâmica de Memória" class="md-nav__link">
      10 - Alocação Dinâmica de Memória
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../11-tipos-de-dados/" title="11 - Tipos abstratos de dados" class="md-nav__link">
      11 - Tipos abstratos de dados
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        12 - Linux do Zero
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="12 - Linux do Zero" class="md-nav__link md-nav__link--active">
      12 - Linux do Zero
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tarefas-preliminares" class="md-nav__link">
    Tarefas preliminares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilando-o-kernel" class="md-nav__link">
    Compilando o kernel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-biblioteca-padrao-libc" class="md-nav__link">
    A biblioteca padrão - libc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ferramentas-de-modo-usuario-busybox" class="md-nav__link">
    Ferramentas de modo usuário - busybox
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#criando-o-sistema-de-arquivos" class="md-nav__link">
    Criando o sistema de arquivos
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../13-entrada-saida/" title="13 - Entrada/Saída" class="md-nav__link">
      13 - Entrada/Saída
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../14-processos/" title="14 - Processos" class="md-nav__link">
      14 - Processos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../15-exec/" title="15 - Carregamento de programas" class="md-nav__link">
      15 - Carregamento de programas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../16-sinais-1/" title="16 - Sinais 1" class="md-nav__link">
      16 - Sinais 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../99-corretor-automatico/" title="99 - Corretor Automático" class="md-nav__link">
      99 - Corretor Automático
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Projetos
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Projetos" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Projetos
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/bomblab/" title="Bomb Lab" class="md-nav__link">
      Bomb Lab
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/posix/" title="Linux do Zero" class="md-nav__link">
      Linux do Zero
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tarefas-preliminares" class="md-nav__link">
    Tarefas preliminares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilando-o-kernel" class="md-nav__link">
    Compilando o kernel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-biblioteca-padrao-libc" class="md-nav__link">
    A biblioteca padrão - libc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ferramentas-de-modo-usuario-busybox" class="md-nav__link">
    Ferramentas de modo usuário - busybox
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#criando-o-sistema-de-arquivos" class="md-nav__link">
    Criando o sistema de arquivos
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/insper/sistemashardwaresoftware/edit/master/docs/aulas/12-linux-do-zero/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="12-linux-do-zero">12 - Linux do Zero<a class="headerlink" href="#12-linux-do-zero" title="Permanent link">&para;</a></h1>
<h2 id="tarefas-preliminares">Tarefas preliminares<a class="headerlink" href="#tarefas-preliminares" title="Permanent link">&para;</a></h2>
<p>Vamos precisar dos seguintes softwares instalados no sistema. Como o resto do curso, os pacotes abaixo são para o Ubuntu 20.04 LTS,</p>
<blockquote>
<p>build-essential flex bison qemu ncurses-dev libssl-dev libelf-dev qemu-system-x86</p>
</blockquote>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Instale os pacotes acima no seu sistema usando <code>apt</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie um programa que mostra a mensagem <em>Hello world (seu nome)</em>. Compile-o e chame-o <code>hello-dyn</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Execute o comando <code>ldd ./hello-dyn</code> e veja sua saída.</p>
</div>
<p>O comando <code>ldd</code> é usado para listar todas as bibliotecas dinâmicas usadas por um executável. Antes de rodar <code>hello-dyn</code> o Linux garante que todos os arquivos listados no exercício anterior estão carregados na memória também. Por esta razão, cada arquivo <code>.so</code> listado é chamado de <strong>dependência</strong> de <code>hello-dyn</code>.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Vamos agora usar a flag <code>-static</code> do <code>gcc</code> para embutir todos os arquivos acima em um único executável. Crie um novo executável <code>hello-static</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Execute ambos e veja que eles possuem o mesmo resultado.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Execute <code>ldd</code> no arquivo <code>hello-static</code> e verifique que ele não tem nenhuma dependência.</p>
</div>
<p>Vamos usar ambos programas mais para a frente do roteiro.</p>
<h2 id="compilando-o-kernel">Compilando o kernel<a class="headerlink" href="#compilando-o-kernel" title="Permanent link">&para;</a></h2>
<p>Vamos primeiro fazer o download do kernel do Linux no <a href="https://www.kernel.org/">site oficial</a>(<a href="https://www.kernel.org/">https://www.kernel.org/</a>). Podem baixar a versão mais recente (atualmente<code>5.9</code>)</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Decompacte o arquivo baixado e examine os arquivos na pasta criada.</p>
<p>$&gt; tar xvf linux-X.Y.Z.tar.xz</p>
</div>
<p>Isto criará uma pasta <code>linux-X.Y.Z</code> que contém os fontes de todo o kernel. O kernel pode ser compilado com uma quantidade enorme de configurações diferentes, sendo que a configuração atual é salva no arquivo <code>.config</code> dentro da pasta do código fonte.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie um kernel com as opções padrão usando o  comando.</p>
<div class="highlight"><pre><span></span><code>$&gt; make defconfig
</code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Podemos customizar as configurações disponíveis usando o comando abaixo. Execute-o e explore um pouco as possibilidades.</p>
<div class="highlight"><pre><span></span><code>$&gt; make menuconfig
</code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Habilite a opção <em>Linux guest support</em> dentro de <em>Processor Type and Features</em>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Execute <code>make -j8</code> para compilar seu kernel.</p>
</div>
<p>O exercício acima demora em torno de 10~20 minutos.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Verifique que foi criado o arquivo <code>bzImage</code> na pasta <code>linux-X.Y.Z/arch/x86_64/boot/</code>. Este é o arquivo executável contendo o kernel Linux que compilamos.</p>
</div>
<h2 id="a-biblioteca-padrao-libc">A biblioteca padrão - <code>libc</code><a class="headerlink" href="#a-biblioteca-padrao-libc" title="Permanent link">&para;</a></h2>
<p>A biblioteca padrão <em>C</em> é contém uma função em <em>C</em> para cada chamada de sistema disponível e interpreta os códigos de erro, deixando-os em um formato (um pouco) mais amigável. Como vimos em aula, realizar chamadas de sistema é uma tarefa que depende do hardware e por isso é diferente em cada arquitetura (ARM vs x86, por exemplo). Logo, a <code>libc</code> oferece uma camada de abstração maior acima do sistema operacional, já que programas construídos usando suas função são portáveis em nível de código fonte. Ou seja, necessitando somente a recompilação do executável para funcionar em outras plataformas. Ela também oferece as funcionalidades necessárias para carregar dinamicamente bibliotecas <code>.so</code>, como vimos na aula 11. Por outro lado, além do kernel precisamos portar a <code>libc</code> também cada vez que trabalhamos com arquiteturas novas.</p>
<p>Neste exemplo iremos usar a <code>glibc</code>, implementação feita pela GNU e usada na maioria das distribuições. Desta vez não precisamos compilar nada: ela já está instalada no nosso sistema e podemos simplesmente usá-la na próxima parte.</p>
<h2 id="ferramentas-de-modo-usuario-busybox">Ferramentas de modo usuário - <code>busybox</code><a class="headerlink" href="#ferramentas-de-modo-usuario-busybox" title="Permanent link">&para;</a></h2>
<p>Agora que já temos uma interface com o kernel via <code>glibc</code> precisamos de programas básicos para utilizar nosso sistema. Estamos falando de programas como <code>cp</code>, <code>ls</code> e até mesmo o nosso shell (<code>bash</code>). Assim como o kernel e a libc, o padrão <em>POSIX</em> também diz como esses programas deverão funcionar, fazendo com que sua utilização básica seja igual em qualquer sistema compatível. Lembre-se que o kernel não faz nada, ele apenas <em>intermedia</em> o acesso ao hardware. Precisamos então de programas que irão tornar esse hardware útil.</p>
<p>O <em>busybox</em>(<a href="https://busybox.net/about.html">https://busybox.net/about.html</a>) é um conjunto de ferramentas modo usuário bastante compacto e rápido. Ele contém implementações leves dos executáveis <code>ash</code> (shell leve alternativo ao <code>bash</code>), <code>ls</code>, <code>vi</code>, <code>pwd</code>, etc. Sua vantagem é o baixo consumo de memória e seu tamanho pequeno após compilado. É muito usado em sistemas embarcados.</p>
<p>Vamos começar baixando os fontes da versão <code>1.31.1</code>. A compilação é feita no mesmo esquema do kernel:</p>
<div class="highlight"><pre><span></span><code>$&gt; make defconfig
$&gt; make menuconfig
</code></pre></div>
<div class="admonition question medium">
<p class="admonition-title">Question</p>
<p>O busy box disponibiliza um grande número de ferramentas. Procure no menu acima o lugar onde são listados os editores de texto disponíveis no <em>busybox</em>.</p>
</div>
<p>Desta vez iremos fazer uma modificação nas configurações padrão. Como queremos que esses executáveis pequenos, muito rápidos e que rodem sem qualquer outro tipo de serviço carregado no sistema, iremos compilá-los <strong>estaticamente</strong>.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Procure a opção para lincar o <code>busybox</code>estaticamente (Submenu <em>Settings</em>), habilite-a e faça a compilação.</p>
<div class="highlight"><pre><span></span><code>$&gt; make -j8
</code></pre></div>
</div>
<p>Isto demorará bem menos que a compilação do kernel e pode ser feito enquanto outras coisas acontecem. Após a compilação um executável <code>busybox</code> deverá ter sido gerado na pasta <em>busybox-1.31.1</em>.</p>
<p>O <code>busybox</code> inclui, em um só executável, todas ferramentas listadas acima. Para executá-las basta passar o nome da ferramenta escolhida como argumento. Veja o exemplo abaixo.</p>
<div class="highlight"><pre><span></span><code>$&gt; ./busybox ls
</code></pre></div>
<p>Se tudo funcionou igual ao <code>ls</code> padrão de seu sistema então passe para o próximo passo.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Execute <code>busybox ls --help</code>. Compare a saída com <code>ls --help</code>. Existe diferença? Procure na saída do <code>ls</code> do seu sistema qual a implementação utilizada.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Você pode obter uma lista completa de todas as ferramentas que o busybox oferece executando <code>busybox --list-full</code>. Execute o comando e interprete sua saída. Esses comandos estão disponíveis no seu sistema atual?</p>
</div>
<h2 id="criando-o-sistema-de-arquivos">Criando o sistema de arquivos<a class="headerlink" href="#criando-o-sistema-de-arquivos" title="Permanent link">&para;</a></h2>
<p>Agora que já temos um kernel, ferramentas de modo usuário e uma <code>libc</code> disponível para compilar programas iremos montar a hierarquia de diretórios do Linux. Esta é a última etapa que precisamos cumprir antes de ter um sistema que faz <em>boot</em>.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Leia a documentação do Debian](<a href="https://wiki.debian.org/FilesystemHierarchyStandard">https://wiki.debian.org/FilesystemHierarchyStandard</a>)(<a href="https://wiki.debian.org/FilesystemHierarchyStandard">https://wiki.debian.org/FilesystemHierarchyStandard</a>) sobre um padrão adotado pela grande maioria das distribuições. Note que este não é um padrão POSIX (o macOS faz tudo isso diferente e ainda assim segue a especificação).</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>A hierarquia de diretórios não representa (necessariamente) um disco físico, mas sim uma organização das informações disponíveis no sistema. Podemos "pendurar" o conteúdo de um disco em basicamente qualquer diretório.</p>
</div>
<p>Agora que você já conhece um pouco melhor como tudo está organizado em um sistema baseado em Linux, vamos começar criando um arquivo vazio de <em>100Mb</em> que será usado como nosso diretório raiz <code>/</code>.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie um arquivo vazio usando <code>dd</code></p>
<div class="highlight"><pre><span></span><code>$&gt; dd if=/dev/zero of=raiz.img bs=1M count=100
</code></pre></div>
</div>
<p>Antes de continuar, precisamos expor o arquivo acima como um dispositivo de armazenamento para o restante do sistema. Podemos fazer isto usando um <em>loopback device</em>. Este tipo de dispositivo se comporta igual a um disco físico, mas modifica os bytes de um arquivo ao invés de interagir com hardware. O comando <code>losetup</code> é usado para fazer este serviço.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Todo comando cujo prompt começa com <code>#</code> deverá ser executado como <em>root</em>. Você pode fazer isso colocando <code>sudo</code> na frente de todos esses comandos.</p>
</div>
<div class="highlight"><pre><span></span><code>#&gt; losetup -P -f --show raiz.img
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>O comando acima mostra o número do dispositivo criado.</p>
</div>
<p>Agora podemos criar uma <em>tabela de partições</em>. Esta estrutura, gravada no começo de um disco, contém informações que permitem identificar quais <em>partições</em> estão presentes, seus tamanhos e tipo. Em sua essência, uma <em>partição</em> é somente uma subdivisão de um disco físico. Isto ajuda, por exemplo, a instalar vários SOs no mesmo disco sem precisar ter um disco separado para cada sistema. Fazemos tudo isto usando o comando <code>fdisk</code>:</p>
<div class="highlight"><pre><span></span><code>#&gt; fdisk /dev/loop0
</code></pre></div>
<p>O <code>fdisk</code> trabalha como um prompt de comandos. Digite <code>m</code> para conhecer as opções.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie uma partição (comando <code>n</code>) neste disco ocupando todo o espaço disponível. As opções padrão do comando de criar partições são adequadas para nosso uso.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Use o comando <code>p</code> para mostrar o estado atual do disco. Certifique-se de que há uma partição do tipo <em>Linux</em> que ocupe o disco todo. Anote o valor do campo <em>Disk Identifier</em> abaixo.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Não se esqueça de usar o comando <code>w</code> para salvar as partições criadas.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Em Linux um arquivo é simplesmente uma sequência de bytes. Se eu pedir para o sistema interpretar esta sequência como um disco formatado no padrão <em>ext4</em> isto terá o mesmo efeito que se essa sequência de bytes estivesse armazenada diretamente em um disco físico.</p>
</div>
<p>A partir de agora, o dispositivo <em>/dev/loop0</em> (ou algo similar que tenha sido retornado pelo comando acima) é equivalente a um disco físico. Assim como localizamos a primeira partição de um disco usando <code>/dev/sda1</code>, localizamos a primeira partição do nosso <em>loop device</em> usando <code>/dev/loop0p1</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Se você só tem <code>/dev/loop0/</code> e não possui <code>/dev/loop0p1</code> então houve algo errado com a criação das partições de seu disco. Refaça tudo a partir do comando <code>dd</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Vamos agora formatar essa partição e montá-la no diretório <em>raiz_linux</em>.</p>
<div class="highlight"><pre><span></span><code>#&gt; mkfs.ext4 /dev/loop0p1
#&gt; mkdir raiz_linux
#&gt; mount -t ext4 /dev/loop0p1 raiz_linux
</code></pre></div>
</div>
<p>Tudo o que for escrito na pasta <em>raiz_linux</em> será escrito diretamente no nosso arquivo <em>raiz.img</em> da mesma maneira que seria escrito em um disco físico. No nosso caso, tudo o que for colocado nesta pasta estará presente no diretório <code>/</code> do nosso sistema Linux. Ou seja, a pasta <em>raiz_linux/bin</em> no nosso sistema será somente <em>/bin</em>.</p>
<p>Vamos agora copiar para <em>raiz_linux</em> o mínimo necessário para conseguirmos ligar nosso sistema em um prompt de comando <em>bash</em> como <em>root</em>. Várias coisas estarão faltando, mas já conseguiremos</p>
<p>O primeiro passo é montar a hierarquia de arquivos descrita no primeiro exercício desta seção. A lista completa pode ser vista neste link](<a href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard</a>).</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie as pastas descritas no documento acima. Verifique que todas foram criadas rodando <code>ls -l</code> em <code>raiz_linux</code>. As pastas que você criou deverão ser as seguintes:</p>
<div class="highlight"><pre><span></span><code>drwxr-xr-x 2 root root  1024 abr 30 09:46 bin
drwxr-xr-x 2 root root  1024 abr 30 09:46 boot
drwxr-xr-x 2 root root  1024 abr 30 09:46 dev
drwxr-xr-x 2 root root  1024 abr 30 09:46 etc
drwxr-xr-x 2 root root  1024 abr 30 09:46 home
drwxr-xr-x 2 root root  1024 abr 30 09:46 lib
drwx------ 2 root root 12288 abr 30 09:39 lost+found
drwxr-xr-x 2 root root  1024 abr 30 09:46 proc
drwxr-xr-x 2 root root  1024 abr 30 09:46 root
drwxr-xr-x 2 root root  1024 abr 30 09:46 run
drwxr-xr-x 2 root root  1024 abr 30 09:46 sbin
drwxr-xr-x 2 root root  1024 abr 30 09:46 sys
drwxr-xr-x 2 root root  1024 abr 30 09:46 tmp
drwxr-xr-x 7 root root  1024 abr 30 09:46 usr
drwxr-xr-x 2 root root  1024 abr 30 09:46 var
</code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Dê permissões totais para a pasta <code>tmp</code> e somente para o usuário dono na pasta <code>root</code>.</p>
<div class="highlight"><pre><span></span><code>#&gt; chmod 777 tmp
#&gt; chmod 600 root
</code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Copie seu kernel para a pasta <code>boot</code> e o executável do <em>busybox</em> para a pasta <code>usr/bin</code>.</p>
</div>
<p>Como vimos anteriormente, o <em>busybox</em> contém todas as ferramentas de usuário em um único executável. Porém, não é nada prático digitar <em>busybox</em> antes de <strong>todo comando</strong>. Por isso criaremos uma série de links simbólicos que ligam o nome de cada ferramenta oferecida pelo <em>busybox</em> ao seu nome "tradicional".</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Execute o comando abaixo na dentro de <code>raiz_linux</code>.</p>
<div class="highlight"><pre><span></span><code>for util in $(./usr/bin/busybox --list-full); do
 ln -s /usr/bin/busybox $util
done
</code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Liste os arquivos em <code>raiz_linux/bin</code>, <code>raiz_linux/usr/bin</code> e <code>raiz_linux/sbin</code> e veja quais programas estarão disponíveis no nosso sistema.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Copie <code>hello-static</code> e <code>hello-dyn</code> para a pasta <code>raiz_linux/root</code>.</p>
</div>
<h1 id="seu-primeiro-boot">Seu primeiro boot<a class="headerlink" href="#seu-primeiro-boot" title="Permanent link">&para;</a></h1>
<p>Com isto já temos o mínimo necessário para dar <em>boot</em> no sistema, mas não teremos um sistema completamente funcional nem bem montado. A ideia aqui é testar nosso progresso e entender o que falta para esse sistema, que já tem <em>kernel</em> e <em>ferramentas de modo usuário</em>, funcionar de maneira plena. Faremos todas as melhorias no sistema na parte 6.</p>
<div class="admonition question medium">
<p class="admonition-title">Question</p>
<p>Pesquise o que é um <em>boot loader</em> e cite a opção mais comum usada em sistemas linux.</p>
</div>
<p>A instalação de um <em>boot loader</em> é trabalhosa e cheia de possibilidades de erros. Podemos aproveitar o fato do próprio <em>QEmu</em> servir de <em>boot loader</em> para facilitar o desenvolvimento deste roteiro.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Sempre que for usar o <code>qemu</code> não se esqueça de desvincular <code>/dev/loop0p1</code> de <code>raiz_linux</code> usando <code>umount</code>.</p>
</div>
<p>Nosso comando de boot terá o formato abaixo:</p>
<p><div class="highlight"><pre><span></span><code>#&gt; qemu-system-x86_64 \
                     -kernel linux-X.Y.Z/arch/x86_64/boot/bzImage \
                     -append &quot;quiet init=/bin/sh root=PARTUUID=XXXXXXXX-01&quot; \
                     /dev/loop0
</code></pre></div>
Vamos destrinchar essa chamada:</p>
<ul>
<li><code>-enable-kvm</code>: habilita a virtualização por hardware, fazendo com que o sistema <em>guest</em> possa executar em velocidade quase real. Pode ser omitido, mas ficará mais lento.</li>
<li><code>-kernel linux-X.Y.Z/arch/x86_64/boot/bzImage</code>: instrui o <em>QEmu</em> a carregar o kernel presente no caminho passado.</li>
<li><code>-append "quiet init=/bin/sh root=PARTUUID=XXXXXXXX-01"</code>: estas opções são passadas para o kernel e configuram sua execução<ul>
<li><code>quiet</code>: minimiza mensagens de debug</li>
<li><code>init=/bin/sh</code>: aqui configuramos o processo de <code>pid=1</code>. Ele é o cara que dá <code>fork+exec</code> em todos os outros processos do sistema e que dá <code>wait</code> nos orfãos. Inicialmente usamos o shell, mas isso não é bom. Na próxima parte veremos por que.</li>
<li><code>root=PARTUUID=XXXXXXXX-01</code>: sistema de arquivos raiz está na partição <code>01</code> do disco identificado pelo <code>UUID</code> que vocês obtiveram no <code>fdisk</code></li>
</ul>
</li>
<li><code>/dev/loop0</code>: disco a ser colocado na máquina virtual. O <em>Disk Identifier</em> dele (anotado anteriormente) está listado no item acima.</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Adapte o comando acima para usar o disco criado por você e execute-o. Se tudo der certo você estará, em poucos segundos, em um prompt rodando como <em>root</em>.</p>
</div>
<div class="admonition done">
<p class="admonition-title">Done</p>
<p>Você conseguiu seu primeiro boot!</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Tente realizar algumas tarefas nesse sistema. Você pode editar um arquivo ou criar pastas.</p>
</div>
<div class="admonition done">
<p class="admonition-title">Done</p>
<p>Não funcionou? Perfeito! Na próxima aula transformaremos nosso sistema capenga em um sistema mínimo e totalmente funcional.</p>
</div>
<h2 id="inicializacao-do-sistema-init">Inicialização do sistema - <code>init</code><a class="headerlink" href="#inicializacao-do-sistema-init" title="Permanent link">&para;</a></h2>
<p>Se você explorou um pouco o sistema criado na parte anterior já deve ter notado que várias coisas não funcionam. Não conseguimos, por exemplo, escrever em nenhum arquivo. Vamos explorar dois casos mais interessantes:</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>O comando <code>df</code> (<em>disk free</em>) é usado para listar o espaço livre em todos os discos presentes no sistema. Tente executá-lo no seu sistema. O quê acontece?</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>O comando <code>lspci</code> (<em>list pci devices</em>) mostra todos os periféricos ligados diretamente na placa mãe do seu PC. Tente executá-lo no seu sistema. O quê acontece?</p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Consulte as pastas apontadas nos itens anteriores. Elas tem conteúdo? Elas <em>deveriam</em> ter conteúdo?</p>
</div>
<p>Para conseguirmos testar logo, adicionamos ao kernel o parâmetro <code>init=/bin/sh</code>. Este parâmetro diz para o kernel abrir um <em>shell</em> assim que iniciar. Isto também é fonte de nossos problemas, já que nosso sistema não inicializa automaticamente nenhum serviço essencial para seu funcionamento. Ou seja, nosso sistema está capenga pois ele não possui um processo <code>init</code>, que é responsável por supervisionar a criação de todos os sistemas de arquivos especiais (<code>/proc, /sys, /dev/</code>) e por iniciar serviços essenciais para o funcionamento do sistema. Da mesma maneira, ao finalizar ele é responsável por desligar todos os recursos de hardware de maneira segura.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Além de ser usado para mídias removíveis, o comando <code>mount</code> também é usado para criar os diretórios especiais <code>/proc</code> e <code>/sys</code>. Rode os seguintes comandos e verifique que agora <code>df</code> e <code>lspci</code> funcionam corretamente.</p>
<div class="highlight"><pre><span></span><code>#&gt; mount -t proc proc /proc -o nosuid,noexec,nodev
#&gt; mount -t sysfs sys /sys -o nosuid,noexec,nodev
</code></pre></div>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Qual o papel das pastas especias <code>/proc</code> e <code>/sys</code> em um sistema Linux?</p>
</div>
<p>Estes comandos fazem parte da inicialização normal de um sistema e expõe estruturas do kernel para o resto do sistema via arquivos. O <em>busybox</em> já nos fornece um sistema de inicialização bastante simplificado que, entre outras coisas, rodaria estes comandos automaticamente a todo boot. Aproveitaremos ele para três propósitos:</p>
<ol>
<li>executar um script de inicialização que configure todos os diretórios especiais e serviços.</li>
<li>adicionar serviços que proveem uma tela de login</li>
<li>executar um script de finalização que desliga o hardware quando o PC for desligado.</li>
</ol>
<p>Primeiro vamos copiar versões padrão de todos os arquivos de configuração necessários. Os seguintes arquivos estão na pasta <code>configs</code> do repositório da aula.</p>
<ul>
<li><code>passwd, shadow, groups</code>: listam os usuários e grupos presentes. <code>shadows</code> contém hashes das senha.</li>
<li><code>profile</code>: é executado logo após um login correto. Pode ser usado para configurar o terminal.</li>
<li><code>issue</code>: contém o nome do seu sistema mostrado na tela de login.</li>
<li><code>hosts</code>: associa um nome com alguns IPs. É aqui que associamos <em>localhost</em> a <code>127.0.0.1</code></li>
<li><code>hostname</code>: configura o nome da nossa máquina na rede.</li>
<li><code>fstab</code>: lista todos os discos que devem ser montados além do <em>rootfs</em>.</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Copie estes arquivos para o <code>etc</code> do seu sistema.</p>
</div>
<p>O sistema de <code>init</code> disponibilizado pelo <em>busybox</em> lê o arquivo <code>/etc/inittab</code> e o interpreta de acordo com as regras mostradas no arquivo <em>busybox-1.30.1/examples/inittab</em>. Iremos usar o arquivo disponível em <code>configs/inittab</code>.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Leia o arquivo <code>config/inittab</code> e tente interpretar seu conteúdo.</p>
</div>
<p>A primeira coluna do arquivo mostra o momento em que ela deve rodar. Vemos, por exemplo, que o script <code>/etc/init.d/startup</code> rodará ao inicializar o sistema e que toda vez que o processo <code>/sbin/getty</code> (terminal com login) terminar ele é reiniciado. Também existem scripts para serem rodados ao desligar o sistema.</p>
<p>Em especial, este arquivo <code>/etc/init.d/startup</code> (presente no repositório como <code>configs/init.d/startup</code>) contém comandos para configurar o sistema, incluindo os diretórios especiais que mostramos acima. Seu conteúdo é mostrado abaixo por completude.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Monta os sistemas de arquivos especiais</span>
mount -t proc proc /proc -o nosuid,noexec,nodev
mount -t sysfs sys /sys -o nosuid,noexec,nodev

<span class="c1"># Configura detector de dispositivos</span>
mkdir -p /dev/pts /dev/shm
mount -t tmpfs shm /dev/shm -o <span class="nv">mode</span><span class="o">=</span><span class="m">1777</span>,nosuid,nodev
mdev -s
<span class="nb">echo</span> /sbin/mdev &gt; /proc/sys/kernel/hotplug

<span class="c1"># Configura terminais</span>
mount -t devpts devpts /dev/pts -o <span class="nv">mode</span><span class="o">=</span><span class="m">0620</span>,gid<span class="o">=</span><span class="m">5</span>,nosuid,noexec

<span class="c1"># Configura /run, que guarda algumas informações de execução.</span>
mount -t tmpfs run /run -o <span class="nv">mode</span><span class="o">=</span><span class="m">0755</span>,nosuid,nodev

<span class="c1"># Atribui nome ao PC</span>
cat /etc/hostname &gt; /proc/sys/kernel/hostname

<span class="c1"># Monta todos os sistemas de arquivos contidos em /etc/fstab</span>
mount -a

mount -o remount,rw /
</code></pre></div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Este script requer a criação de um diretório <code>/run</code>. Para que ele serve? Crie-o e copie ambos arquivos acima para seu sistema.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Modifique sua linha de comando do <em>QEmu</em> e retire a porção <code>init=/bin/sh</code>. Por padrão o kernel buscará o executável <code>/sbin/init</code>, que usará os arquivos que criamos para inicializar o sistema.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Se tudo deu certo você deverá ter um prompt de login. Logue como <em>root</em> e continue o roteiro.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Não se esqueça de usar <code>umount</code> para desmontar a pasta <code>raiz_linux</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie um arquivo dentro de seu sistema. Você pode usar o editor <code>vi</code> ou o comando <code>touch</code> para criar um arquivo vazio. Se não deu certo revise se ocorreu tudo certo na execução do seu script <code>startup</code> rolando a tela para cima com <code>Shift+PageUp</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Desligue seu sistema com <code>poweroff</code>. Ligue-o novamente e confira se o arquivo ainda está lá.</p>
</div>
<h1 id="parte-7-bibliotecas-e-carregamento-dinamico">Parte 7 - bibliotecas e carregamento dinâmico<a class="headerlink" href="#parte-7-bibliotecas-e-carregamento-dinamico" title="Permanent link">&para;</a></h1>
<p>Quando compilamos o <em>busybox</em> habilitamos uma opção que pedia executáveis compilados estaticamente, fazendo que o executável criado não tenha dependências. Vamos agora aprender a configurar nosso sistema para rodar executáveis com dependências.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Copie os executáveis <code>hello-static</code> e <code>hello-dyn</code> para sua VM. Não se esqueça de adicionar permissões de execução para eles.</p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Tente rodar ambos executáveis. Ambos funcionam? Anote abaixo o resultado da execução de cada um.</p>
</div>
<p>Todos os executáveis que conseguimos rodar até agora foram compilados estaticamente. Quando tentamos rodar <code>hello-dyn</code> tivemos um erro.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Execute (em seu sistema) <code>ldd</code> em <code>hello-dyn</code>. Anote abaixo as dependências encontradas.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Os arquivos acima existem na sua VM?</p>
</div>
<p>Ao montar nosso sistema do zero não incluimos nenhuma biblioteca! Logo, o nosso executável não consegue carregar as partes faltantes e não irá rodar. Felizmente, nosso sistema Linux possui a mesma arquitetura do Ubuntu instalado em nossas máquinas e podemos copiar os arquivos necessários para nosso sistema!</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Copie os arquivos acima para os locais indicados na saída de <code>ldd</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Teste novamente <code>hello-dyn</code>. Agora ele funciona?</p>
</div>
<p>Gerenciar <strong>dependências</strong> é a principal atribuição de gerenciadores de pacotes como <code>apt</code>, <code>pacman</code> e <code>dnf</code>. Eles estruturam todos os softwares instaláveis em um sistema de modo que ao instalar um programa todas as suas dependências sejam instaladas também.</p>
<div class="admonition done">
<p class="admonition-title">Done</p>
<p>Pronto! Agora temos um sistema mínimo e funcional. Ainda faltam vários pedaços que normalmente compõem um sistema, como um bootloader instalado na imagem de disco e um gerenciador de pacotes. Mas ao menos agora ele é plenamente funcional dentro do que propomos.</p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../11-tipos-de-dados/" title="11 - Tipos abstratos de dados" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                11 - Tipos abstratos de dados
              </div>
            </div>
          </a>
        
        
          <a href="../13-entrada-saida/" title="13 - Entrada/Saída" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                13 - Entrada/Saída
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
      
        <script src="../../translate-admonitions.js"></script>
      
    
  </body>
</html>